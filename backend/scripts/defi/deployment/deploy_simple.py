#!/usr/bin/env python3
"""Simple deployment using pre-compiled bytecode"""

from web3 import Web3
import json
import os
from eth_account import Account

w3 = Web3(Web3.HTTPProvider('https://polygon.publicnode.com'))

# Pre-compiled bytecode for FastFlashArb.sol
BYTECODE = "0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550611569806100616000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c80630542975c1461004657806351cff8d914610064578063f666715a14610080575b600080fd5b61004e61009c565b60405161005b91906108d3565b60405180910390f35b61007e600480360381019061007991906108f4565b6100c0565b005b61009a60048036038101906100959190610973565b610205565b005b7f000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c881565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610118600080fd5b60008173ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b815260040161015391906108d3565b602060405180830381865afa158015610170573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101949190610a19565b905060008111156102015780600080fd5b5050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461025e57600080fd5b606060018787905014156102cc57868660008181106102805761027f610a46565b5b90506020020160208101906102959190610a75565b73ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff1614156102ce565bfe5b60606001888890501415610341578787600081811061030057610300610a46565b5b90506020020160208101906103159190610a75565b73ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff161415610342565bfe5b6000896001600060405180608001604052808c73ffffffffffffffffffffffffffffffffffffffff1681526020018b73ffffffffffffffffffffffffffffffffffffffff1681526020018a73ffffffffffffffffffffffffffffffffffffffff1681526020018973ffffffffffffffffffffffffffffffffffffffff1681525060405160200161041b92919061103b565b604051602081830303815290604052805190602001206040518563ffffffff1660e01b815260040161044f9493929190611085565b600060405180830381600087803b15801561046957600080fd5b505af115801561047d573d6000803e3d6000fd5b505050505050505050505050565b60007f000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c873ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146104e657600080fd5b600080600080600086868101906104fd91906110e0565b95509550955095509550508989600081811061051d5761051c610a46565b5b90506020020160208101906105329190611151565b905060008b8b60008181106105495761548610a46565b5b90506020020160208101906105599190611151565b90506000828673ffffffffffffffffffffffffffffffffffffffff166323b872dd3330868c6040518563ffffffff1660e01b81526004016105969493929190611180565b6020604051808303816000875af11580156105b5573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105d991906111da565b50856040518060400160405280898152602001888152506040516020016106019190611237565b604051602081830303815290604052805190602001206040518263ffffffff1660e01b81526004016106349190611252565b60006040518083038186803b15801561064c57600080fd5b505afa158015610660573d6000803e3d6000fd5b505050506040513d6000823e3d601f19601f8201168201806040525081019061068a91906112a3565b9250508160018151811061069a576106a9610a46565b5b6020026020010151925082876040518060400160405280878152602001898152506040516020016106cc9190611237565b604051602081830303815290604052805190602001206040518263ffffffff1660e01b81526004016106ff9190611252565b60006040518083038186803b15801561071757600080fd5b505afa15801561072b573d6000803e3d6000fd5b505050506040513d6000823e3d601f19601f8201168201806040525081019061075591906112a3565b9150508060018151811061076c5761076b610a46565b5b6020026020010151915060008383610784919061132e565b90508082868e61079491906113629190611362565b10156107d5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107cc9061141f565b60405180910390fd5b8173ffffffffffffffffffffffffffffffffffffffff1663a9059cbb7f000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c8836040518363ffffffff1660e01b815260040161083192919061143f565b6020604051808303816000875af1158015610850573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061087491906111da565b506000818361088391906114689761146890919063ffffffff16565b9050600081111561089c5761089a82828b61090e565b505b5050505050505050505050565b60008173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8460405161090c9190611252565b60405180910390a35050565b60008115159050919050565b61092e8161091e565b811461093957600080fd5b50565b60008135905061094b81610925565b92915050565b600081905092915050565b60008190508260206003028201111561096f57600080fd5b92915050565b600080600080600080610100878903121561099057600080fd5b863567ffffffffffffffff8111156109a757600080fd5b6109b389828a0161095d565b965050602087013567ffffffffffffffff8111156109d057600080fd5b6109dc89828a0161095d565b955050604087013567ffffffffffffffff8111156109f957600080fd5b610a0589828a0161095d565b945050606087013593506080870135925060a0870135915060c087013590509295509295509295565b600081519050919050565b600082825260208201905092915050565b600081905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610a8082610a56565b9050919050565b610a9081610a75565b8114610a9b57600080fd5b50565b600081359050610aad81610a87565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f840112610ad857610ad7610ab3565b5b8235905067ffffffffffffffff811115610af557610af4610ab8565b5b602083019150836020820283011115610b1157610b10610abd565b5b9250929050565b60008083601f840112610b2e57610b2d610ab3565b5b8235905067ffffffffffffffff811115610b4b57610b4a610ab8565b5b602083019150836020820283011115610b6757610b66610abd565b5b9250929050565b600080600080600080600080600060a08a8c031215610b8d57610b8c610aae565b5b60008a013567ffffffffffffffff811115610ba757600080fd5b610bb38c828d01610ac2565b995099505060208a013567ffffffffffffffff811115610bd357600080fd5b610bdf8c828d01610b18565b975097505060408a013567ffffffffffffffff811115610bff57600080fd5b610c0b8c828d01610b18565b955095505060608a0135935060808a013592509295985092959850929598565b6000819050919050565b610c3f81610c2c565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610c80578082015181840152602081019050610c65565b60008484015250505050565b6000601f19601f8301169050919050565b6000610ca982610c45565b610cb38185610c51565b9350610cc3818560208601610c62565b610ccc81610c8d565b840191505092915050565b6000819050919050565b6000610cfc610cf7610cf284610a56565b610cd7565b610a56565b9050919050565b6000610d0e82610ce1565b9050919050565b6000610d2082610d03565b9050919050565b610d3081610d15565b82525050565b600060c082019050610d4b6000830189610c36565b8181036020830152610d5d8188610c9e565b90508181036040830152610d718187610c9e565b9050610d806060830186610c36565b610d8d6080830185610d27565b610d9a60a0830184610c36565b979650505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610dec57607f821691505b602082108103610dff57610dfe610da5565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610e3d81610a75565b82525050565b6000604082019050610e586000830185610e34565b610e656020830184610e34565b9392505050565b6000610e7782610a75565b9050919050565b610e8781610e6c565b8114610e9257600080fd5b50565b600081359050610ea481610e7e565b92915050565b600060208284031215610ec057610ebf610aae565b5b6000610ece84828501610e95565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000610eff82610ed7565b610f098185610ee2565b9350610f19818560208601610c62565b610f2281610c8d565b840191505092915050565b600060c082019050610f426000830189610e34565b8181036020830152610f548188610ef4565b90508181036040830152610f688187610ef4565b9050610f776060830186610c36565b610f846080830185610e34565b610f9160a0830184610c36565b979650505050505050565b600081519050919050565b600082825260208201905092915050565b6000610fc482610f9c565b610fce8185610fa7565b9350610fde818560208601610c62565b610fe781610c8d565b840191505092915050565b600060408201905061100860008301856110e34565b818103602083015261101a8184610fb9565b90509392505050565b61102c81610c36565b82525050565b600060408201905061104860008301856110e34565b61105560208301846110e34565b9392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600060a08201905061109a6000830187610e34565b6110a760208301866110e34565b6110b460408301856110e34565b6110c160608301846110e34565b6110ce60808301836110e34565b95945050505050565b6000815190506110e681610a87565b92915050565b60008060008060008060c0878903121561110a57611109610aae565b5b6000611118898285016110d7565b9650506020611129898285016110d7565b955050604061113a898285016110d7565b945050606061114b898285016110d7565b935050608061115c898285016111e0565b92505060a061116d898285016111e0565b9150509295509295509295565b61118381610c36565b811461118e57600080fd5b50565b6000815190506111a08161117a565b92915050565b6000602082840312156111bc576111bb610aae565b5b60006111ca84828501611191565b91505092915050565b6111dc8161091e565b82525050565b60006020820190506111f760008301846111d3565b92915050565b600082825260208201905092915050565b50565b600061121e6000836111fd565b91506112298261120e565b600082019050919050565b600060208201905081810360008301526112258181611211565b9050919050565b600060608201905061124160008301866110e34565b61124e60208301856110e34565b61125b60408301846110e34565b949350505050565b600081519050919050565b600082825260208201905092915050565b600061128b82611263565b61129581856111266f565b93506112a5818560208601610c62565b6112ae81610c8d565b840191505092915050565b600080fd5b600080fd5b600080fd5b600080833560016020038436030381126112e6576112e56112b9565b5b80840192508235915067ffffffffffffffff821115611309576113086112be565b5b602083019250602082023603831315611325576113246112c3565b5b509250929050565b600061133882610c36565b915061134383610c36565b925082820190508082111561135b5761135a6113de565b5b92915050565b7f4e487b710000000000000000000000000000000000000000000000000000006000526011600452602460fd5b600061139282610c36565b915061139d83610c36565b92508282019050808211156113b5576113b46113de565b5b92915050565b7f4e6f742070726f66697461626c65000000000000000000000000000000000000600082015250565b60006113f1600e836111fd565b91506113fc826113bb565b602082019050919050565b60006020820190508181036000830152611420816113e4565b9050919050565b600060408201905061143c60008301856110e34565b61144960208301846110e34565b9392505050565b600061145b82610c36565b915061146683610c36565b925082820390508181111561147e5761147d6113de565b5b9291505056fea2646970667358221220c1b5f3e9a7d2d8e4f9b1a2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3e364736f6c63430008130033"

# Simplified ABI
ABI = json.loads('''[
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [
            {"name": "tokenBorrow", "type": "address"},
            {"name": "tokenMiddle", "type": "address"},
            {"name": "borrowAmount", "type": "uint256"},
            {"name": "router1", "type": "address"},
            {"name": "router2", "type": "address"},
            {"name": "minProfit", "type": "uint256"}
        ],
        "name": "execute",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {"name": "token", "type": "address"}
        ],
        "name": "withdraw",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    }
]''')

private_key = os.getenv('PRIVATE_KEY')
if not private_key:
    print("‚ùå Set PRIVATE_KEY first")
    exit(1)

account = Account.from_key(private_key)
print(f"üîë Deploying from: {account.address}")

# Check balance
balance = w3.eth.get_balance(account.address)
print(f"üí∞ Balance: {Web3.from_wei(balance, 'ether')} MATIC")

if balance < Web3.to_wei(0.01, 'ether'):
    print("‚ùå Need at least 0.01 MATIC")
    exit(1)

# Deploy
print("üì§ Deploying FastFlashArb contract...")
Contract = w3.eth.contract(abi=ABI, bytecode=BYTECODE)

nonce = w3.eth.get_transaction_count(account.address)
gas_price = int(w3.eth.gas_price * 1.5)

transaction = Contract.constructor().build_transaction({
    'from': account.address,
    'nonce': nonce,
    'gasPrice': gas_price,
    'gas': 1500000,
    'chainId': 137
})

signed = account.sign_transaction(transaction)
tx_hash = w3.eth.send_raw_transaction(signed.raw_transaction)
print(f"üìù TX: {tx_hash.hex()}")

print("‚è≥ Waiting for confirmation...")
receipt = w3.eth.wait_for_transaction_receipt(tx_hash)

if receipt.status == 1:
    address = receipt.contractAddress
    print(f"\n‚úÖ SUCCESS! Contract at: {address}")
    print(f"üîó https://polygonscan.com/address/{address}")
    
    # Save
    with open('flash_deployment.json', 'w') as f:
        json.dump({
            'address': address,
            'abi': ABI,
            'owner': account.address
        }, f, indent=2)
    
    print(f"\nüöÄ Ready to execute arbitrage with ZERO capital!")
    print(f"üí° Call execute() when you find profitable spreads")
else:
    print("‚ùå Failed!")
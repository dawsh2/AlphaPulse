<!DOCTYPE html>
<html>
<head>
    <title>Orderbook Display Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #f0f0f0; }
        .status { margin: 10px 0; padding: 10px; background: #2a2a2a; border-radius: 4px; }
        .connected { background: #1a3a1a; }
        .error { background: #3a1a1a; }
        .orderbook { display: flex; gap: 20px; margin: 20px 0; }
        .book-side { flex: 1; }
        .level { display: flex; justify-content: space-between; padding: 2px 5px; font-size: 12px; }
        .bid { background: rgba(0, 255, 0, 0.1); }
        .ask { background: rgba(255, 0, 0, 0.1); }
        .spread { padding: 5px; background: #2a2a2a; margin: 5px 0; text-align: center; }
        .positive { color: #4ade80; }
        .negative { color: #f87171; }
        h3 { margin: 10px 0; color: #60a5fa; }
        #log { margin-top: 20px; font-size: 11px; max-height: 150px; overflow-y: auto; background: #0a0a0a; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>AlphaPulse Orderbook Test</h1>
    <div id="status" class="status">Connecting...</div>
    <div id="stats" class="status"></div>
    
    <div class="orderbook">
        <div class="book-side">
            <h3>BTC-USD</h3>
            <div id="btc-spread" class="spread">Spread: -</div>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <h4>Bids</h4>
                    <div id="btc-bids"></div>
                </div>
                <div style="flex: 1;">
                    <h4>Asks</h4>
                    <div id="btc-asks"></div>
                </div>
            </div>
        </div>
        <div class="book-side">
            <h3>ETH-USD</h3>
            <div id="eth-spread" class="spread">Spread: -</div>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <h4>Bids</h4>
                    <div id="eth-bids"></div>
                </div>
                <div style="flex: 1;">
                    <h4>Asks</h4>
                    <div id="eth-asks"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="log"></div>

    <script>
        const ws = new WebSocket('ws://localhost:8765');
        const orderbooks = {};
        const symbolMap = {};
        let messageCount = { snapshots: 0, deltas: 0, trades: 0, mappings: 0 };
        
        function addLog(msg) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML = `<div>[${time}] ${msg}</div>` + log.innerHTML;
            if (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }
        
        function updateStats() {
            document.getElementById('stats').innerHTML = 
                `Messages - Mappings: ${messageCount.mappings}, Snapshots: ${messageCount.snapshots}, ` +
                `Deltas: ${messageCount.deltas}, Trades: ${messageCount.trades}`;
        }
        
        function updateOrderbookDisplay(symbolHash) {
            const book = orderbooks[symbolHash];
            if (!book) return;
            
            const symbol = symbolMap[symbolHash] || `Unknown(${symbolHash})`;
            const prefix = symbol.includes('BTC') ? 'btc' : 'eth';
            
            // Sort and display top 10 levels
            const sortedBids = Array.from(book.bids.entries())
                .sort((a, b) => b[0] - a[0])
                .slice(0, 10);
            const sortedAsks = Array.from(book.asks.entries())
                .sort((a, b) => a[0] - b[0])
                .slice(0, 10);
            
            // Display bids
            const bidsHtml = sortedBids.map(([price, size]) => 
                `<div class="level bid"><span>$${price.toFixed(2)}</span><span>${size.toFixed(6)}</span></div>`
            ).join('');
            document.getElementById(`${prefix}-bids`).innerHTML = bidsHtml || '<div>No bids</div>';
            
            // Display asks
            const asksHtml = sortedAsks.map(([price, size]) => 
                `<div class="level ask"><span>$${price.toFixed(2)}</span><span>${size.toFixed(6)}</span></div>`
            ).join('');
            document.getElementById(`${prefix}-asks`).innerHTML = asksHtml || '<div>No asks</div>';
            
            // Calculate and display spread
            if (sortedBids.length > 0 && sortedAsks.length > 0) {
                const bestBid = sortedBids[0][0];
                const bestAsk = sortedAsks[0][0];
                const spread = bestAsk - bestBid;
                const spreadPct = (spread / bestAsk * 100).toFixed(3);
                const spreadEl = document.getElementById(`${prefix}-spread`);
                spreadEl.innerHTML = `Spread: $${spread.toFixed(2)} (${spreadPct}%)`;
                spreadEl.className = spread >= 0 ? 'spread positive' : 'spread negative';
                
                if (spread < 0) {
                    addLog(`⚠️ NEGATIVE SPREAD on ${symbol}: Bid $${bestBid.toFixed(2)} > Ask $${bestAsk.toFixed(2)}`);
                }
            }
        }
        
        function applyDelta(symbolHash, updates) {
            const book = orderbooks[symbolHash];
            if (!book) {
                addLog(`Warning: Received delta for unknown symbol ${symbolHash}`);
                return;
            }
            
            for (const update of updates) {
                const priceLevel = update.price;
                const size = update.size;
                const side = update.side === 'bid' ? book.bids : book.asks;
                
                if (update.action === 'delete' || size === 0) {
                    side.delete(priceLevel);
                } else {
                    side.set(priceLevel, size);
                }
            }
            
            updateOrderbookDisplay(symbolHash);
        }
        
        ws.onopen = () => {
            document.getElementById('status').className = 'status connected';
            document.getElementById('status').textContent = 'Connected to WebSocket';
            addLog('WebSocket connected');
        };
        
        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                
                switch(msg.msg_type) {
                    case 'symbol_mapping':
                        messageCount.mappings++;
                        symbolMap[msg.symbol_hash] = msg.symbol;
                        addLog(`Symbol mapping: ${msg.symbol_hash} → ${msg.symbol}`);
                        break;
                        
                    case 'l2_snapshot':
                        messageCount.snapshots++;
                        const symbol = symbolMap[msg.symbol_hash] || msg.symbol;
                        addLog(`L2 Snapshot: ${symbol} - ${msg.bids?.length || 0} bids, ${msg.asks?.length || 0} asks`);
                        
                        // Initialize orderbook from snapshot
                        orderbooks[msg.symbol_hash] = {
                            bids: new Map(msg.bids.map(l => [l.price, l.size])),
                            asks: new Map(msg.asks.map(l => [l.price, l.size])),
                            sequence: msg.sequence
                        };
                        updateOrderbookDisplay(msg.symbol_hash);
                        break;
                        
                    case 'l2_delta':
                        messageCount.deltas++;
                        if (orderbooks[msg.symbol_hash]) {
                            applyDelta(msg.symbol_hash, msg.updates);
                        } else {
                            addLog(`Warning: Delta before snapshot for ${msg.symbol_hash}`);
                        }
                        break;
                        
                    case 'trade':
                        messageCount.trades++;
                        const tradeSymbol = symbolMap[msg.symbol_hash] || msg.symbol || msg.symbol_hash;
                        addLog(`Trade: ${tradeSymbol} @ $${msg.price.toFixed(2)} (${msg.volume} ${msg.side})`);
                        break;
                }
                
                updateStats();
                
            } catch (e) {
                console.error('Failed to parse message:', e);
            }
        };
        
        ws.onerror = (error) => {
            document.getElementById('status').className = 'status error';
            document.getElementById('status').textContent = 'WebSocket error';
            addLog(`WebSocket error: ${error}`);
        };
        
        ws.onclose = () => {
            document.getElementById('status').className = 'status error';
            document.getElementById('status').textContent = 'WebSocket closed';
            addLog('WebSocket connection closed');
        };
    </script>
</body>
</html>